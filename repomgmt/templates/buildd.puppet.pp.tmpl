$tarball = "/var/lib/schroot/tarballs/chroot.tgz"

package { 'haveged': } ->
package { 'sbuild': } ->
user { "ubuntu":
    groups => "sbuild",
} ->
file { "/var/lib/schroot/tarballs":
    ensure => directory,
} ->
exec { "fetch-tarball":
    command => "/usr/bin/wget -O $tarball {{ build_record.get_tarball.download_link }}",
    creates => $tarball,
} -> 
file { "$tarball":
    require => Exec["fetch-tarball"],
    owner => "root",
    group => "root",
} ->
file { "/etc/schroot/chroot.d'":
    ensure => "directory",
} ->
file { "/etc/schroot/chroot.d/sbuild":
    content => '[buildchroot]
description=buildchroot
groups=sbuild,root,admin
root-groups=sbuild,root,admin
source-root-users=sbuild,root,admin
source-root-groups=sbuild,root,admin
type=file
file=/home/ubuntu/chroot.tgz
',
} ->
exec { "/usr/bin/sbuild-update --keygen":
}
